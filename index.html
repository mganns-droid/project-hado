<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Hado | Resonance & Breath</title>
    
    <!-- Scripts & Compilation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-in { animation-fill-mode: both; }
        .fade-in { animation: fade-in 0.8s ease-out; }
        .slide-up { animation: slide-up 0.8s ease-out; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        /* Sequential Box Tracer Styles */
        .box-container {
            width: 240px;
            height: 240px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            border-radius: 4px;
        }

        .tracer-line {
            position: absolute;
            background: white;
            box-shadow: 0 0 15px white, 0 0 30px rgba(255,255,255,0.5);
            border-radius: 2px;
            opacity: 0;
            transition: none; 
        }

        /* Essential: Width/Height transitions only occur when active class is applied */
        .tracer-line.active {
            opacity: 1;
            transition: width var(--duration) linear, height var(--duration) linear, opacity 0.2s ease-in;
        }

        .chamber-fill {
            transition: height var(--duration) ease-in-out, opacity 0.4s ease-in-out;
        }

        .breathing-shape {
            transition: transform var(--duration, 4000ms) ease-in-out;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 overflow-x-hidden font-sans selection:bg-cyan-500/30">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wind, Play, Pause, RotateCcw, Home, X, 
            CheckCircle2, ChevronRight, Brain, Zap, 
            ArrowUp, ArrowDown, ActivitySquare, 
            Volume2, VolumeX, Share2, Microscope, List, 
            Headphones, Loader2, Copy, Check, AlertCircle
        } from 'lucide-react';

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Hado Critical Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-slate-950 text-cyan-50 font-sans">
                            <h2 className="text-xl font-light mb-4 text-center px-6 tracking-tight">System synchronisation interrupted.</h2>
                            <button onClick={() => window.location.hash = ''} className="px-10 py-4 bg-cyan-600 rounded-full font-bold uppercase text-xs tracking-widest transition-all hover:bg-cyan-500 shadow-lg">Return to Home</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const GlobalDisclaimer = ({ lightMode = false }) => (
            <div className={`w-full py-8 text-center px-6 ${lightMode ? 'text-white/40' : 'text-slate-500'}`}>
                <p className="text-[10px] leading-relaxed max-w-2xl mx-auto uppercase tracking-widest font-bold opacity-70 font-sans">
                    Psych and Lifestyle Disclaimer: Educational use only. Consult clinical professionals for medical guidance.
                </p>
            </div>
        );

        // --- Sensory Engine ---
        const pcmToWav = (pcmBase64, sampleRate = 24000) => {
            const binaryString = atob(pcmBase64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const buffer = new ArrayBuffer(44 + bytes.length);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + bytes.length, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(36, 'data'); view.setUint32(40, bytes.length, true);
            for (let i = 0; i < bytes.length; i++) { view.setUint8(44 + i, bytes[i]); }
            return URL.createObjectURL(new Blob([buffer], { type: 'audio/wav' }));
        };

        const useHadoAudio = () => {
            const audioCtx = useRef(null);
            const masterGain = useRef(null);
            const activeAudioRef = useRef(null); 
            const isInit = useRef(false);
            const apiKey = ""; // Workspace Injection

            const stop = useCallback(() => {
                if (masterGain.current && audioCtx.current) {
                    masterGain.current.gain.setTargetAtTime(0, audioCtx.current.currentTime, 0.05);
                }
                window.speechSynthesis?.cancel();
                if (activeAudioRef.current) {
                    activeAudioRef.current.pause();
                    activeAudioRef.current.currentTime = 0;
                    activeAudioRef.current = null;
                }
            }, []);

            const init = useCallback(() => {
                if (isInit.current) {
                    if (audioCtx.current.state === 'suspended') audioCtx.current.resume();
                    return;
                }
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                audioCtx.current = ctx;
                const gain = ctx.createGain();
                gain.gain.value = 0;
                gain.connect(ctx.destination);
                masterGain.current = gain;

                const frequencies = [110, 146.83, 164.81]; 
                frequencies.forEach(f => {
                    const osc = ctx.createOscillator();
                    const filter = ctx.createBiquadFilter();
                    const oscGain = ctx.createGain();
                    osc.type = 'sine'; osc.frequency.value = f;
                    filter.type = 'lowpass'; filter.frequency.value = 400;
                    oscGain.gain.value = 0.12;
                    osc.connect(filter); filter.connect(oscGain); oscGain.connect(gain);
                    osc.start();
                });
                isInit.current = true;
            }, []);

            const updateSound = useCallback((action, durationMs, isMuted) => {
                if (!audioCtx.current) return;
                const now = audioCtx.current.currentTime;
                if (isMuted) {
                    masterGain.current.gain.setTargetAtTime(0, now, 0.05);
                    return;
                }
                const seconds = durationMs / 1000;
                if (action.includes('Inhale')) masterGain.current.gain.setTargetAtTime(0.3, now, seconds * 0.3);
                else if (action === 'Exhale' || action === 'Whoosh') masterGain.current.gain.setTargetAtTime(0.04, now, seconds * 0.4);
                else masterGain.current.gain.setTargetAtTime(0.08, now, 0.5);
            }, []);

            const speakLocal = (text, profile = "female") => {
                console.warn(`[HADO] Neural Fetch Failed. Fallback to Local ${profile} voice synthesis.`);
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = window.speechSynthesis.getVoices();
                if (profile === "female") {
                    utterance.voice = voices.find(v => (v.name.includes('Female') || v.lang === 'en-AU' || v.name.includes('Lydia'))) || voices[0];
                } else {
                    utterance.voice = voices.find(v => (v.name.includes('Male') || v.lang === 'en-GB' || v.name.includes('Daniel'))) || voices[0];
                }
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            };

            const speakGemini = async (text, voiceProfile = "Leda") => {
        try {
                    if (activeAudioRef.current) activeAudioRef.current.pause();

            const response = await fetch('/.netlify/functions/tts', {                        method: 'POST',
                body: JSON.stringify({ text, voiceProfile }),                            contents: [{ parts: [{ text: text }] }],
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) throw new Error(`Fetch Error: ${response.status}`);
                    const result = await response.json();
                    const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioData) {
                        console.log(`[HADO] Success: Playing Neural ${voiceProfile} audio stream.`);
                        const audio = new Audio(pcmToWav(audioData));
                        activeAudioRef.current = audio;
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(() => speakLocal(text, voiceProfile === "Leda" ? "female" : "male"));
                        }
                        return audio;
                    }
                } catch (error) {
                    console.error(`[HADO] Neural Engine failed:`, error);
                    speakLocal(text, voiceProfile === "Leda" ? "female" : "male"); 
                }
                return null;
            };

            return { init, updateSound, speakLocal, speakGemini, stop };
        };

        // --- Dataset ---
        const TECHNIQUES = [
            {
                id: 'coherent',
                name: 'Coherent Breathing',
                tagline: 'Autonomic Regulation',
                description: 'Synchronises heart, lung, and brain rhythms at a resonance frequency of 5.5 breaths per minute.',
                citation: 'Lehrer, P. M., & Gevirtz, R. (2014). Heart rate variability biofeedback: How and why does it work? Frontiers in Psychology, 5, 756. https://doi.org/10.3389/fpsyg.2014.00756',
                science: 'Breathing at this specific rate maximises Heart Rate Variability (HRV) and synchronises the baroreflex mechanism, promoting homeostatic balance.',
                steps: ['Inhale smoothly for 6 seconds', 'Exhale smoothly for 6 seconds', 'Maintain fluid transitions'],
                auditoryExplanation: "Coherent breathing is a standardised resonance frequency protocol. It involves equalising the inhalation and exhalation phases to approximately six seconds each. This synchronises heart rate variability with respiratory rhythms, optimising baroreflex sensitivity and promoting autonomic balance.",
                pattern: [{ action: 'Inhale', subtext: 'Smoothly', duration: 6000 }, { action: 'Exhale', subtext: 'Smoothly', duration: 6000 }],
                color: 'text-violet-400', bgGradient: 'from-violet-950 to-slate-900'
            },
            {
                id: 'sigh',
                name: 'Physiological Sigh',
                tagline: 'Rapid Neural Reset',
                description: 'A biological mechanism used by the brain to reinflate collapsed alveoli and rapidly offload carbon dioxide.',
                citation: 'Balban, M. Y., Neri, E., Kogon, M. M., Wu, A., Holmes, S., Spiegel, D., & Huberman, A. D. (2023). Brief structured respiration practices enhance mood and reduce physiological arousal. Cell Reports Medicine, 4, 100895. https://doi.org/10.1016/j.xcrm.2022.100891',
                science: 'Evidence suggests that a deep nasal inhale followed by a sharp second inhale reinflates collapsed lung sacs. This increases the surface area for clearing carbon dioxide during the subsequent long oral exhale.',
                steps: ['Deep Nasal Inhale (Maximal)', 'Sharp "Top-off" Inhale (Nose)', 'Extended Oral Exhale'],
                auditoryExplanation: "The physiological sigh is a rapid neural de-escalation mechanism. Research by the Huberman Lab suggests that a deep nasal inhale followed by a sharp second inhale reinflates collapsed lung sacs. This increases the surface area for clearing carbon dioxide during the subsequent long oral exhale.",
                pattern: [{ action: 'Deep Inhale', subtext: 'Full nose inhale', duration: 5000 }, { action: 'Top Up', subtext: 'Sharp and short', duration: 1000 }, { action: 'Exhale', subtext: 'Long oral release', duration: 8000 }],
                color: 'text-rose-400', bgGradient: 'from-rose-950 to-slate-900'
            },
            {
                id: 'box',
                name: 'Box Breathing',
                tagline: 'Executive Focus',
                description: 'A standardised technique used by high-performance professionals to maintain composure during high-arousal scenarios.',
                citation: 'Huber, A. S., Fehr, J., Lin, J., O’Gorman Tuura, R., & Critchley, H. D. (2023). Brief structured respiration practices enhance mood and reduce physiological arousal. Cell Reports Medicine, 4(1), 100895. https://doi.org/10.1016/j.xcrm.2022.100891',
                science: 'Equal breath quadrants provide a stable external tempo that suppresses the amygdala\'s panic signal and enables executive control.',
                steps: ['Inhale 4s', 'Hold 4s', 'Exhale 4s', 'Hold 4s'],
                auditoryExplanation: "Box breathing is an executive control technique utilised to maintain cognitive performance under high-arousal conditions. It involves four equal phases: inhalation, internal retention, exhalation, and external retention—each lasting four seconds.",
                pattern: [{ action: 'Inhale', subtext: 'Quadrant 1', duration: 4000 }, { action: 'Hold', subtext: 'Full', duration: 4000 }, { action: 'Exhale', subtext: 'Quadrant 3', duration: 4000 }, { action: 'Hold', subtext: 'Empty', duration: 4000 }],
                color: 'text-cyan-400', bgGradient: 'from-slate-900 to-slate-800'
            },
            {
                id: 'relax',
                name: '4-7-8 Relax',
                tagline: 'Sedative Regulation',
                description: 'A scientifically validated sequence used to lower neural arousal and facilitate rapid sleep onset.',
                citation: 'Dinda, N. P. A. R., Putra, I. G. N. E., & Wibawa, A. A. G. (2026). Effect of the 4‑7‑8 breathing technique on sleep quality in university students. Majalah Ilmiah Fisioterapi Indonesia, 14(1), 118–123',
                science: 'The extended 8-second exhale increases intrathoracic pressure, inducing immediate vagal stimulation and neural settling.',
                steps: ['Inhale for 4 seconds', 'Hold for 7 seconds', 'Whoosh exhale for 8 seconds'],
                auditoryExplanation: "The four seven eight sequence is a potent sedative method. By extending the exhalation to eight seconds, you increase intrathoracic pressure and stimulate the vagus nerve. This triggers a profound parasympathetic release.",
                pattern: [{ action: 'Inhale', subtext: 'Quietly', duration: 4000 }, { action: 'Hold', subtext: 'Gently', duration: 7000 }, { action: 'Exhale', subtext: 'Whoosh', duration: 8000 }],
                color: 'text-emerald-400', bgGradient: 'from-emerald-950 to-slate-900'
            },
            {
                id: 'alt-nostril',
                name: 'Alternate Nostril',
                tagline: 'Hemispheric Equilibrium',
                description: 'A structural breathwork method aimed at balancing hemispheric activity and centring the mind.',
                citation: 'Telles S, Nagarathna R, Nagendra HR. Breathing through a particular nostril can alter metabolism and autonomic activities. Indian J Physiol Pharmacol. 1994;38(2):133–137.',
                science: 'Modulating lateral airflow influences the nasal cycle, which is linked to brain hemisphere dominance and autonomic branch balance.',
                steps: ['Block Right, Inhale Left', 'Hold and Switch', 'Exhale Right', 'Inhale Right', 'Hold and Switch', 'Exhale Left'],
                auditoryExplanation: "Alternate nostril breathing, or Nadi Shodhana, is a hemispheric balancing protocol. By modulating lateral airflow, you influence the ultradian nasal cycle, which is linked to brain hemisphere dominance and autonomic branch balance.",
                pattern: [{ action: 'Inhale Left', subtext: '', duration: 4000 }, { action: 'Hold', subtext: 'Switch', duration: 2000 }, { action: 'Exhale Right', subtext: '', duration: 4000 }, { action: 'Inhale Right', subtext: '', duration: 4000 }, { action: 'Hold', subtext: 'Switch', duration: 2000 }, { action: 'Exhale Left', subtext: '', duration: 4000 }],
                color: 'text-amber-400', bgGradient: 'from-amber-950 to-slate-900'
            },
            {
                id: 'left-nostril',
                name: 'Left Nostril Breath',
                tagline: 'Parasympathetic Induction',
                description: 'Exclusively stimulates the calming branch of the nervous system for restorative rest.',
                citation: 'Bhavanani, A. B., et al. (2014). Immediate effect of Chandra Nadi Pranayama on cardiovascular parameters in hypertension. International Journal of Yoga.',
                science: 'In traditional physiology, the left nostril is associated with the "Ida Nadi" or lunar channel, representing the body\'s cooling and restorative energy linked to parasympathetic dominance.',
                steps: ['Block right nostril during this exercise', 'Nasal inhale left', 'Nasal exhale left'],
                auditoryExplanation: "Left nostril breathing is an exclusively parasympathetic induction technique. In traditional systems, it is referred to as the 'Ida Nadi' or lunar channel, representing cooling energy. To practise, block your right nostril during this exercise and breathe solely through the left side.",
                pattern: [{ action: 'Inhale Left', subtext: 'Sedative', duration: 4000 }, { action: 'Exhale Left', subtext: 'Sedative', duration: 6000 }],
                color: 'text-indigo-300', bgGradient: 'from-indigo-950 to-slate-900'
            }
        ];

        // --- Main Views ---

        const Introduction = ({ onComplete }) => (
            <div className="min-h-screen bg-slate-950 p-6 md:p-12 flex flex-col items-center overflow-y-auto font-sans animate-in fade-in">
                <div className="max-w-4xl w-full space-y-12 pb-12 text-center">
                    <header className="flex flex-col items-center gap-8">
                        <a href="https://www.psychandlifestyle.com" target="_blank" rel="noopener noreferrer">
                            <img src="https://storage.googleapis.com/msgsndr/75wNipinfMtmoPkQ3ahW/media/66f5da343f1c6b7934489e92.png" className="w-24 md:w-32 drop-shadow-2xl hover:scale-105 transition-transform" alt="Psych and Lifestyle" />
                        </a>
                        <h1 className="text-4xl md:text-6xl font-extralight tracking-tight text-white leading-none">The Power of Your Breath</h1>
                        <p className="text-xl text-slate-400 font-light italic">Resonance & Regulation</p>
                    </header>
                    <div className="relative aspect-video bg-slate-900 rounded-[2rem] overflow-hidden border border-slate-800 shadow-2xl animate-in fade-in">
                        <iframe src="https://player.vimeo.com/video/1139753900?h=bf031d93c3&title=0&byline=0&portrait=0" className="absolute inset-0 w-full h-full" frameBorder="0" allow="autoplay; fullscreen" />
                    </div>
                    <div className="grid md:grid-cols-2 gap-8 animate-in slide-up">
                        <div className="p-10 rounded-[2.5rem] bg-rose-950/10 border border-rose-900/20 text-left"><h3 className="text-rose-400 mb-4 flex items-center gap-3 uppercase tracking-widest text-xs font-black"><Zap size={18}/> Stress Response</h3><p className="text-sm text-slate-300 leading-relaxed font-light">Thoracic breathing keeps the system locked in high-arousal reactive cognitive patterns.</p></div>
                        <div className="p-10 rounded-[2.5rem] bg-emerald-950/10 border border-emerald-900/20 text-left"><h3 className="text-emerald-400 mb-4 flex items-center gap-3 uppercase tracking-widest text-xs font-black"><Brain size={18}/> Recovery State</h3><p className="text-sm text-slate-300 leading-relaxed font-light">Diaphragmatic modulation signals safety to the brainstem, enabling executive functioning.</p></div>
                    </div>
                    <button onClick={onComplete} className="px-12 py-5 bg-white text-slate-950 rounded-full font-black uppercase text-xs tracking-widest hover:scale-105 transition-all shadow-[0_20px_60px_rgba(255,255,255,0.1)]">Open Breathing Toolkit <ChevronRight className="inline ml-1" size={18}/></button>
                    <GlobalDisclaimer />
                </div>
            </div>
        );

        const Session = ({ technique, onExit }) => {
            const [isActive, setIsActive] = useState(false);
            const [stepIdx, setStepIdx] = useState(0);
            const [isMuted, setIsMuted] = useState(false);
            const audio = useHadoAudio();
            const step = technique.pattern[stepIdx];
            const countingInterval = useRef(null);

            const handleRhythmicGuidance = useCallback((currentStep) => {
                if (isMuted) return;
                // Enforce Grounding Male voice (Charon) for counting sessions
                if (technique.id === 'sigh') {
                    if (currentStep.action === 'Deep Inhale') audio.speakGemini("Deep inhale through the nose", "Charon");
                    if (currentStep.action === 'Top Up') audio.speakGemini("And top up, sharp inhale", "Charon");
                    if (currentStep.action === 'Exhale') audio.speakGemini("Long exhale through the mouth", "Charon");
                    if (currentStep.action === 'Deep Inhale') {
                        let count = 1;
                        countingInterval.current = setInterval(() => {
                            if (count < 5) { count++; audio.speakGemini(count.toString(), "Charon"); }
                            else { clearInterval(countingInterval.current); }
                        }, 1000);
                    }
                    return;
                }
                audio.speakGemini(currentStep.action, "Charon");
                const totalSeconds = Math.floor(currentStep.duration / 1000);
                if (totalSeconds >= 3) {
                    let count = 1;
                    countingInterval.current = setInterval(() => {
                        if (count < totalSeconds) { count++; audio.speakGemini(count.toString(), "Charon"); }
                        else { clearInterval(countingInterval.current); }
                    }, 1000);
                }
            }, [audio, technique.id, isMuted]);

            useEffect(() => {
                if (!isActive) { audio.stop(); if (countingInterval.current) clearInterval(countingInterval.current); return; }
                const current = technique.pattern[stepIdx];
                audio.updateSound(current.action, current.duration, isMuted);
                handleRhythmicGuidance(current);
                const timer = setTimeout(() => { setStepIdx(prev => (prev + 1) % technique.pattern.length); }, current.duration);
                return () => { clearTimeout(timer); if (countingInterval.current) clearInterval(countingInterval.current); };
            }, [isActive, stepIdx, isMuted, technique, audio, handleRhythmicGuidance]);

            const renderVisual = () => {
                const duration = `${isActive ? step.duration : 500}ms`;
                if (technique.id === 'box') {
                    return (
                        <div className="box-container flex items-center justify-center">
                            {/* Static keys ensure browser animates the change in width/height rather than remounting the div */}
                            <div key="box-0" className={`tracer-line ${stepIdx === 0 && isActive ? 'active' : ''}`} style={{ top: 0, left: 0, height: '3px', width: stepIdx === 0 && isActive ? '100%' : '0%', '--duration': duration }} />
                            <div key="box-1" className={`tracer-line ${stepIdx === 1 && isActive ? 'active' : ''}`} style={{ top: 0, right: 0, width: '3px', height: stepIdx === 1 && isActive ? '100%' : '0%', '--duration': duration }} />
                            <div key="box-2" className={`tracer-line ${stepIdx === 2 && isActive ? 'active' : ''}`} style={{ bottom: 0, right: 0, height: '3px', width: stepIdx === 2 && isActive ? '100%' : '0%', transformOrigin: 'right', '--duration': duration }} />
                            <div key="box-3" className={`tracer-line ${stepIdx === 3 && isActive ? 'active' : ''}`} style={{ bottom: 0, left: 0, width: '3px', height: stepIdx === 3 && isActive ? '100%' : '0%', transformOrigin: 'bottom', '--duration': duration }} />
                        </div>
                    );
                }
                if (technique.id === 'alt-nostril' || technique.id === 'left-nostril') {
                    const isLeft = step.action.includes('Left') || technique.id === 'left-nostril';
                    const inhale = step.action.includes('Inhale') || step.action === 'Top Up';
                    return (
                        <div className="flex gap-10 items-end h-60 w-60 relative border-b border-white/5 pb-4 px-6 font-sans">
                             <div className="flex-1 bg-white/[0.02] rounded-t-[3rem] overflow-hidden relative h-full border border-white/5">
                                <div className="absolute bottom-0 w-full bg-amber-400/40 chamber-fill" style={{ height: isLeft && inhale ? '100%' : isLeft ? '25%' : '10%', '--duration': duration, opacity: isLeft ? 1 : 0.05 }} />
                             </div>
                             <div className="flex-1 bg-white/[0.02] rounded-t-[3rem] overflow-hidden relative h-full border border-white/5">
                                <div className="absolute bottom-0 w-full bg-amber-400/40 chamber-fill" style={{ height: !isLeft && inhale ? '100%' : !isLeft ? '25%' : '10%', '--duration': duration, opacity: !isLeft ? 1 : 0.05 }} />
                             </div>
                        </div>
                    );
                }
                const scale = step.action.includes('Inhale') || step.action === 'Top Up' ? 1.6 : 1.0;
                return (
                    <div className="w-60 h-60 rounded-full border border-white/10 bg-white/5 shadow-[0_0_80px_rgba(255,255,255,0.03)] relative flex items-center justify-center breathing-shape" style={{ transform: `scale(${scale})`, '--duration': duration }}>
                        <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-white/10 to-transparent animate-pulse" />
                    </div>
                );
            };

            return (
                <div className={`h-screen flex flex-col items-center justify-center bg-gradient-to-b ${technique.bgGradient} transition-colors duration-1000`}>
                    <button onClick={() => { audio.stop(); onExit(); }} className="absolute top-12 left-12 p-5 rounded-full bg-black/40 hover:bg-black/60 text-white/80 border border-white/5 transition-all"><X size={20}/></button>
                    <div className="mb-32 flex items-center justify-center w-80 h-80 relative font-sans">
                        {renderVisual()}
                        <div className="absolute flex flex-col items-center gap-3 pointer-events-none text-center">
                            <h2 className="text-4xl font-extralight tracking-[0.3em] uppercase text-white leading-none font-sans">{isActive ? step.action : 'Initialising'}</h2>
                            <p className="text-[11px] text-white/40 font-black uppercase tracking-widest">{step.subtext}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-10 z-50">
                        <button onClick={() => { setIsActive(false); setStepIdx(0); audio.stop(); }} className="p-6 rounded-full bg-white/5 hover:bg-white/10 text-white/40 transition-all"><RotateCcw size={24}/></button>
                        <button onClick={() => { audio.init(); setIsActive(!isActive); }} className="p-12 rounded-full bg-white text-slate-950 shadow-3xl hover:scale-110 active:scale-95 transition-all">{isActive ? <Pause fill="currentColor" size={36}/> : <Play fill="currentColor" className="ml-1" size={36}/>}</button>
                        <div className="flex flex-col gap-4">
                             <button onClick={() => setIsMuted(!isMuted)} className={`p-4 rounded-full transition-colors ${isMuted ? 'bg-rose-500/20 text-rose-400 shadow-lg shadow-rose-900/20' : 'bg-white/5 text-white/60'}`}><VolumeX size={22}/></button>
                        </div>
                    </div>
                    <div className="mt-20 text-center space-y-3 px-6 font-sans text-white"><p className="text-2xl font-extralight tracking-wide">{technique.name}</p><p className="text-[10px] text-white/20 uppercase tracking-[0.5em] font-black">{technique.tagline}</p></div>
                    <div className="absolute bottom-8 w-full opacity-20"><GlobalDisclaimer lightMode /></div>
                </div>
            );
        };

        const Detail = ({ technique, onBack, onStart }) => {
            const [isPlayingGuide, setIsPlayingGuide] = useState(false);
            const [isLoadingGuide, setIsLoadingGuide] = useState(false);
            const [copied, setCopied] = useState(false);
            const [showShare, setShowShare] = useState(false);
            const sensory = useHadoAudio();

            const shareUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}#detail/${technique.id}`;

            const handleCopy = () => {
                const el = document.createElement('textarea'); el.value = shareUrl; document.body.appendChild(el); el.select();
                try { document.execCommand('copy'); setCopied(true); setTimeout(() => setCopied(false), 2000); } catch(e) {}
                document.body.removeChild(el);
            };

            const playExplanation = async () => {
                if (isPlayingGuide) { sensory.stop(); setIsPlayingGuide(false); return; }
                setIsLoadingGuide(true);
                // Enforce Female Narrative voice (Leda) for overviews
                const audioObj = await sensory.speakGemini(technique.auditoryExplanation, "Leda");
                setIsLoadingGuide(false);
                if (audioObj) { setIsPlayingGuide(true); audioObj.onended = () => setIsPlayingGuide(false); }
            };

            return (
                <div className="min-h-screen bg-slate-950 p-6 md:p-12 animate-in fade-in overflow-y-auto font-sans text-white font-sans">
                    <div className="max-w-5xl mx-auto space-y-20 pb-16">
                        <div className="flex justify-between items-center flex-wrap gap-4 font-sans">
                            <button onClick={() => { sensory.stop(); onBack(); }} className="flex items-center gap-4 text-slate-500 hover:text-white uppercase text-[11px] tracking-[0.4em] font-black transition-colors font-sans"><X size={18}/> Return to Menu</button>
                            <div className="flex gap-4">
                                <button onClick={() => setShowShare(!showShare)} className={`flex items-center gap-3 px-6 py-3 rounded-full border transition-all uppercase text-[10px] tracking-widest font-black bg-slate-900 border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 font-sans`}><Share2 size={16} /> Share</button>
                                <button onClick={playExplanation} disabled={isLoadingGuide} className={`flex items-center gap-3 px-6 py-3 rounded-full border transition-all uppercase text-[10px] tracking-widest font-black ${isPlayingGuide ? 'bg-cyan-900/40 border-cyan-400 text-cyan-400' : 'bg-slate-900 border-slate-700 text-slate-400 hover:text-white hover:border-slate-500'} font-sans`}>{isLoadingGuide ? <Loader2 className="animate-spin" size={16} /> : isPlayingGuide ? <VolumeX size={16} /> : <Headphones size={16} />} {isLoadingGuide ? "Initialising..." : isPlayingGuide ? "Stop Guide" : "Listen to Guide"}</button>
                            </div>
                        </div>
                        {showShare && (
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-3xl flex flex-col md:flex-row items-center gap-4 animate-in slide-up font-sans font-sans">
                                <input readOnly value={shareUrl} className="flex-1 bg-black/40 border border-white/5 rounded-xl p-4 font-mono text-xs text-cyan-400 outline-none w-full" />
                                <button onClick={handleCopy} className="bg-white text-slate-950 px-8 py-4 rounded-xl font-bold uppercase text-[10px] tracking-widest flex items-center gap-2 shrink-0 transition-transform active:scale-95">{copied ? <Check size={16} /> : <Copy size={16} />} {copied ? "Copied" : "Copy Link"}</button>
                            </div>
                        )}
                        <div className="grid lg:grid-cols-2 gap-20">
                            <div className="space-y-12">
                                <div className="space-y-6">
                                    <h1 className="text-6xl md:text-7xl font-extralight tracking-tighter leading-none">{technique.name}</h1>
                                    <p className={`text-2xl font-light tracking-wide ${technique.color}`}>{technique.tagline}</p>
                                </div>
                                <p className="text-slate-300 leading-relaxed text-2xl font-extralight italic border-l-2 border-white/5 pl-10 font-sans italic font-sans">"{technique.description}"</p>
                                <button onClick={() => { sensory.stop(); onStart(); }} className="w-full md:w-auto px-14 py-7 bg-white text-slate-950 rounded-full font-black uppercase text-xs tracking-widest shadow-[0_25px_60px_rgba(255,255,255,0.15)] hover:scale-105 transition-all flex items-center justify-center gap-5">Start Session <ChevronRight size={24}/></button>
                                <div className="border-t border-white/5 pt-8 mt-4 font-sans font-sans"><p className="text-[10px] text-slate-500 italic uppercase tracking-widest mb-1 font-black leading-none">Peer-Reviewed Source:</p><p className="text-[11px] text-slate-400 leading-relaxed font-light">{technique.citation}</p></div>
                            </div>
                            <div className="space-y-8 font-sans">
                                <div className="p-10 rounded-[2.5rem] bg-slate-900/40 border border-slate-800/60 space-y-6 shadow-2xl font-sans"><h4 className="flex items-center gap-3 text-cyan-400 uppercase text-[11px] tracking-[0.3em] font-black font-sans"><Microscope size={18}/> Physiological Mechanism</h4><p className="text-sm text-slate-300 leading-relaxed font-light font-sans">{technique.science}</p></div>
                                <div className="p-10 rounded-[2.5rem] bg-slate-900/40 border border-slate-800/60 space-y-6 shadow-2xl font-sans"><h4 className="flex items-center gap-3 text-purple-400 uppercase text-[11px] tracking-[0.3em] font-black font-sans"><List size={18}/> Practise Guidelines</h4><ul className="space-y-5 font-sans">{technique.steps.map((s, i) => (<li key={i} className="text-sm text-slate-300 flex items-start gap-4 font-light leading-snug font-sans font-sans"><span className="flex-shrink-0 w-6 h-6 rounded-full bg-purple-500/20 text-purple-400 text-[10px] flex items-center justify-center font-black mt-1">{i+1}</span><span>{s}</span></li>))}</ul></div>
                            </div>
                        </div>
                        <GlobalDisclaimer />
                    </div>
                </div>
            );
        };

        const Menu = ({ onSelect, onBackToIntro }) => (
            <div className="min-h-screen bg-slate-950 p-6 md:p-12 animate-in fade-in overflow-y-auto font-sans text-white font-sans">
                <header className="max-w-6xl mx-auto flex flex-col items-center mb-24 font-sans gap-8">
                    <div className="flex flex-col items-center gap-8 font-sans">
                        <a href="https://www.psychandlifestyle.com" target="_blank" rel="noopener noreferrer">
                            <img src="https://storage.googleapis.com/msgsndr/75wNipinfMtmoPkQ3ahW/media/66f5da343f1c6b7934489e92.png" className="w-24 md:w-32 drop-shadow-2xl hover:scale-105 transition-transform" alt="Psych and Lifestyle Logo" />
                        </a>
                        <div className="text-center font-sans">
                            <a href="https://www.psychandlifestyle.com" target="_blank" rel="noopener noreferrer" className="hover:opacity-80 transition-opacity">
                                <h1 className="text-3xl font-extralight tracking-[0.3em] leading-none font-sans">HADO</h1>
                                <p className="text-[10px] uppercase tracking-[0.5em] text-slate-500 font-black font-sans font-sans font-sans">Resonance & Breath</p>
                            </a>
                        </div>
                    </div>
                    <button onClick={onBackToIntro} className="p-4 rounded-full bg-slate-900 border border-slate-800 text-slate-600 hover:text-cyan-400 transition-colors shadow-2xl font-sans"><Home size={22}/></button>
                </header>
                <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 pb-12 font-sans font-sans">
                    {TECHNIQUES.map(t => (
                        <button key={t.id} onClick={() => onSelect(t)} className="p-12 rounded-[3rem] bg-slate-900/40 border border-slate-800/50 text-left hover:border-slate-500 hover:bg-slate-900 transition-all group relative overflow-hidden h-80 flex flex-col justify-between shadow-xl">
                            <div className="relative z-10 space-y-6"><Wind className={`${t.color}`} size={36} strokeWidth={1.5}/><div className="space-y-1"><h3 className="text-3xl font-light tracking-tight text-white">{t.name}</h3><p className={`text-[11px] uppercase tracking-widest ${t.color} font-black`}>{t.tagline}</p></div></div>
                            <div className="text-[11px] text-slate-600 relative z-10 flex items-center gap-3 uppercase tracking-widest font-black"><ActivitySquare size={14}/> {t.pattern.length} Step Cycle</div>
                            <div className={`absolute top-0 right-0 w-64 h-64 bg-gradient-to-br ${t.bgGradient} opacity-0 group-hover:opacity-10 rounded-full blur-[100px] transition-opacity duration-700 font-sans`} />
                        </button>
                    ))}
                </div>
                <div className="mt-20"><GlobalDisclaimer /></div>
            </div>
        );

        const App = () => {
            const [view, setView] = useState('intro');
            const [activeTech, setActiveTech] = useState(null);
            const sensory = useHadoAudio();
            useEffect(() => {
                const h = () => {
                    const hash = window.location.hash.slice(1);
                    const [m, id] = hash.split('/');
                    sensory.stop(); // Global silence on view change
                    if (!m || m === 'intro') { setView('intro'); setActiveTech(null); }
                    else if (m === 'menu') { setView('menu'); setActiveTech(null); }
                    else {
                        const t = TECHNIQUES.find(x => x.id === id);
                        if (t) { setView(m); setActiveTech(t); } else setView('menu');
                    }
                };
                h(); window.addEventListener('hashchange', h); return () => window.removeEventListener('hashchange', h);
            }, [sensory]);
            return (
                <ErrorBoundary>
                    <main className="min-h-screen">
                        {view === 'intro' && <Introduction onComplete={() => window.location.hash = 'menu'} />}
                        {view === 'menu' && <Menu onSelect={t => window.location.hash = `detail/${t.id}`} onBackToIntro={() => window.location.hash = 'intro'} />}
                        {view === 'detail' && activeTech && <Detail technique={activeTech} onBack={() => window.location.hash = 'menu'} onStart={() => window.location.hash = `session/${activeTech.id}`} />}
                        {view === 'session' && activeTech && <Session technique={activeTech} onExit={() => window.location.hash = `detail/${activeTech.id}`} />}
                    </main>
                </ErrorBoundary>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
